# VoiceMode Configuration Pattern

Full example from VoiceMode showing comprehensive configuration system.

## Key Features

1. **Cascading .env Files**
   - Global: `~/.voicemode/voicemode.env`
   - Project: `.voicemode.env` or `.voicemode/voicemode.env`
   - Walks up directory tree to find project config

2. **Auto-Generated Defaults**
   - Creates default config file on first run
   - Comprehensive documentation in comments
   - Secure permissions (0o600)

3. **Helper Functions**
   - `env_bool()` - Parse boolean environment variables
   - `expand_path()` - Expand tildes and environment variables
   - `parse_comma_list()` - Parse comma-separated lists
   - `reload_configuration()` - Runtime config reload

4. **Configuration Organization**
   - Grouped by functionality (Core, Service, Whisper, etc.)
   - Clear comments explaining each setting
   - Default values documented

## File Discovery Pattern

```python
def find_voicemode_env_files() -> list[Path]:
    """
    Find .voicemode.env files by walking up the directory tree.

    Looks for (in order of priority - closest to current directory wins):
    1. .voicemode.env in current or parent directories
    2. .voicemode/voicemode.env in current or parent directories
    3. ~/.voicemode/voicemode.env in user home (global config)

    Returns:
        List of Path objects in loading order (global first, then project-specific)
    """
    config_files = []

    # First add global config (lowest priority - loaded first)
    global_config = Path.home() / ".voicemode" / "voicemode.env"

    # Backwards compatibility: check for old filename
    if not global_config.exists():
        old_global = Path.home() / ".voicemode" / ".voicemode.env"
        if old_global.exists():
            global_config = old_global

    if global_config.exists():
        config_files.append(global_config)

    # Then walk up directory tree for project-specific configs (higher priority)
    current_dir = Path.cwd()
    project_configs = []

    while current_dir != current_dir.parent:
        # Check for standalone .voicemode.env first
        standalone_file = current_dir / ".voicemode.env"
        if standalone_file.exists():
            project_configs.append(standalone_file)
            break  # Stop at first found (closest wins)

        # Then check .voicemode/voicemode.env
        dir_file = current_dir / ".voicemode" / "voicemode.env"
        # Skip if this is the global config file (already added)
        if dir_file.exists() and dir_file != global_config:
            project_configs.append(dir_file)
            break  # Stop at first found (closest wins)

        current_dir = current_dir.parent

    # Add project configs (they were collected closest-first, so add as-is)
    config_files.extend(project_configs)

    return config_files
```

## Configuration Loading

```python
def load_voicemode_env():
    """Load configuration from voicemode.env files, with cascading from global to project-specific."""
    config_files = find_voicemode_env_files()

    # If no config files found, create default global config
    if not config_files:
        default_path = Path.home() / ".voicemode" / "voicemode.env"
        default_path.parent.mkdir(parents=True, exist_ok=True)
        default_config = '''# Voice Mode Configuration File
# This file is automatically generated and can be customized
# Environment variables always take precedence over this file

#############
# Core Configuration
#############

# Base directory for all voicemode data (default: ~/.voicemode)
# VOICEMODE_BASE_DIR=~/.voicemode

# Enable debug mode (true/false)
# VOICEMODE_DEBUG=false
'''
        with open(default_path, 'w') as f:
            f.write(default_config)
        os.chmod(default_path, 0o600)  # Secure permissions
        config_files = [default_path]

    # Load configuration from all files in order (global first, project-specific last)
    for config_path in config_files:
        if config_path.exists():
            with open(config_path, 'r') as f:
                for line in f:
                    line = line.strip()
                    # Skip comments and empty lines
                    if not line or line.startswith('#'):
                        continue
                    # Parse KEY=VALUE format
                    if '=' in line:
                        key, value = line.split('=', 1)
                        key = key.strip()
                        value = value.strip()
                        # Only set if not already in environment (env vars take precedence)
                        if key and key not in os.environ:
                            os.environ[key] = value

# Load configuration file before other configuration
load_voicemode_env()
```

## Module-Level Configuration

Configuration is loaded at module import time:

```python
# Load configuration on import
load_voicemode_env()

# Helper functions
def env_bool(env_var: str, default: bool = False) -> bool:
    """Parse boolean from environment variable."""
    value = os.getenv(env_var, "").lower()
    return value in ("true", "1", "yes", "on") if value else default

def expand_path(path_str: str) -> Path:
    """Expand tilde and environment variables in path strings."""
    expanded = os.path.expandvars(path_str)
    expanded = os.path.expanduser(expanded)
    return Path(expanded)

# Configuration values
BASE_DIR = expand_path(os.getenv("VOICEMODE_BASE_DIR", str(Path.home() / ".voicemode")))
DEBUG = env_bool("VOICEMODE_DEBUG", False)
AUDIO_FORMAT = os.getenv("VOICEMODE_AUDIO_FORMAT", "pcm").lower()
```

## Runtime Reload

```python
def reload_configuration():
    """Reload configuration from files and clear all caches."""
    # Reload environment configuration
    load_voicemode_env()

    # Update global configuration variables
    global TTS_VOICES, TTS_MODELS, TTS_BASE_URLS, STT_BASE_URLS
    TTS_BASE_URLS = parse_comma_list("VOICEMODE_TTS_BASE_URLS", "http://127.0.0.1:8880/v1,https://api.openai.com/v1")
    STT_BASE_URLS = parse_comma_list("VOICEMODE_STT_BASE_URLS", "http://127.0.0.1:2022/v1,https://api.openai.com/v1")

    logger.info("Configuration reloaded successfully")
```
